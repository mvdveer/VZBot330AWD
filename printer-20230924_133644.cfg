
##########################################################################
## Included Configs
##########################################################################

[include macros.cfg]
[include neopixel.cfg]
[include nozzle_scrub.cfg]
#[include timelapse.cfg]
#[include variables.cfg]
[include Adaptive_Mesh.cfg]
[include Adaptive_Purge.cfg]\
[include speed.cfg]

[exclude_object]

##########################################################################
## Mainsail inclusions
##########################################################################

[display_status]
[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[pause_resume]
recover_velocity: 350

##########################################################################
## MCU Section
##########################################################################

[mcu sht36]
canbus_uuid: 21da7204a07b

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_3E0014001050334636383920-if00


##########################################################################
## Printer
##########################################################################

[printer]
kinematics: corexy
max_velocity: 2500
max_accel: 10000
#max_accel_to_decel: 5000
max_z_velocity: 20
max_z_accel: 1500
square_corner_velocity: 10

##########################################################################
#  Resonance - Input Shaper - SHT36
##########################################################################

## SHT36 -ADXL345
[adxl345]
cs_pin: sht36:PA9
spi_software_sclk_pin: sht36:PB13
spi_software_mosi_pin: sht36:PB15
spi_software_miso_pin: sht36:PB14

[resonance_tester]
accel_chip: adxl345
probe_points:
    160, 160, 20


##########################################################################
# SHT36 Temperature sensors
##########################################################################

[temperature_sensor SHT36-V2]     
sensor_type: temperature_mcu      
sensor_mcu: sht36               
min_temp: 0                       
max_temp: 490                     


[temperature_sensor Chamber]          
sensor_type: ATC Semitec 104GT-2  
sensor_pin = sht36:PA4          
min_temp: 0                       
max_temp: 490              


##########################################################################
## Steppers - AWD - TMC 5160 Pro
##########################################################################

[stepper_x]
##	in M0 position
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  
endstop_pin: ^sht36:PA1            #make sure to set the correct pin here.
position_endstop: 330
position_min: 0
position_max: 330
homing_speed: 50  
homing_retract_dist: 0


[tmc2209 stepper_x]                     
uart_pin: PC4
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

[stepper_y]
##	in M1 position
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200
endstop_pin: PG6                 #make sure to set the correct pin here.
position_endstop: 330
position_min: 0
position_max: 330
homing_speed: 50 
homing_retract_dist: 0


[tmc2209 stepper_y]               
uart_pin: PD11
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

[stepper_x1]
##	in M2_1 position
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  


[tmc2209 stepper_x1]               
uart_pin: PC6
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

[stepper_y1]
##	in M3 position
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200

[tmc2209 stepper_y1]              
uart_pin: PC7
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

##########################################################################
# Steppers - Other - TMC2209
##########################################################################

[stepper_z]
## In M4 position
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 32
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop    # use beacon as virtual endstop
homing_retract_dist: 0                            # Beacon does not require a homing retract. Setting this to somethingother than 0 will cause occasional erroneous results.
position_max: 400
full_steps_per_rotation: 200
homing_positive_dir: false
homing_speed: 5.0
second_homing_speed: 2.5

[tmc2209 stepper_z]
uart_pin: PF2
interpolate: false
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 999999

[extruder]
## on Canbus SHT36
### Orbiter 2
step_pin: sht36:PB4
dir_pin: sht36:PB3
enable_pin: !sht36:PA15
microsteps: 16
## Orbiter Extruder
rotation_distance: 22.2
Gear_ratio: 50:8
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: sht36:PA8
sensor_type: ATC Semitec 104GT-2  # this is the default for the Revo heater
pullup_resistor: 4700   
sensor_pin: sht36:PA3
#control: pid
#pid_Kp=28.737 
#pid_Ki=1.935 
#pid_Kd=106.684
min_temp: 0
max_temp: 400
full_steps_per_rotation: 200
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 500
max_extrude_only_velocity: 200
max_extrude_only_accel: 10000
min_extrude_temp: 0
pressure_advance: 0.02
pressure_advance_smooth_time: 0.03

[tmc2209 extruder]
uart_pin: sht36:PB5
interpolate: false
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0

##########################################################################â€¨# Heater Bed
##########################################################################

[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
#control: pid
#pid_Kp: 66.746
#pid_Ki: 3.504
#pid_Kd: 317.878
min_temp: 0
max_temp: 130


##########################################################################
#FANS
##########################################################################

[fan]
##	Print Cooling Fan - SHT36 - Fan1
pin: sht36:PB11
max_power: 1
cycle_time: 0.002
hardware_pwm: false
shutdown_speed: 0

[heater_fan hotend_fan]
##	Hotend Fan - SHT36 FAN0 Connector
pin: sht36:PB10
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[fan_generic Exhaust_fan]
##  exhaust fan - In FAN0
pin: PA8
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10

#[fan_generic chamber_fan]
###  chamber fan - In FAN9 Position
#pin: PD15
#max_power: 1
#shutdown_speed: 0
#kick_start_time: 0.1
#off_below: 0.10

[fan_generic RSCS]
##  RSCS Fans - In FAN1 Position
pin: PE5
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10


##########################################################################
#Custom PINs Definition 
##########################################################################

[output_pin Caselight]
# Connected to HE0
pin: PA2
pwm: false
value: 1
shutdown_value:0

[idle_timeout]
timeout: 1800
gcode =
  {% if printer.pause_resume.is_paused %}
    M104 S0
  {% else %}
    TURN_OFF_HEATERS
    #M84
  {% endif %}

########################################################################
## Probe          Beacon Probe Replaces This.                                                                                                            
########################################################################

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_B55F5B954E4B333448202020FF0A2128-if00
#serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_1659E13C4E4B333448202020FF0A1816-if00
speed: 5.                                             #   Z probing dive speed.
#lift_speed: 5.                                       #   Z probing lift speed.
#backlash_comp: 0.5                           #   Backlash compensation distance for removing Z backlash before measuring the sensor response.
x_offset: 0                                             #   X offset of beacon from the nozzle.  update with offset from nozzle on your machine
y_offset: -15                                             #   Y offset of beacon from the nozzle. update with offset from nozzle on your machine
#trigger_distance: 2.                             #   Beacon trigger distance for homing.
#trigger_dive_threshold: 1.                   #   Threshold for range vs dive mode probing. Beyond `trigger_distance + trigger_dive_threshold` a dive will be used.
#trigger_hysteresis: 0.006                    #   Hysteresis on trigger threshold for untriggering, as a percentage of the trigger threshold.
#cal_nozzle_z: 0.1                                 #   Expected nozzle offset after completing manual Z offset calibration.
#cal_floor: 0.2                                        #   Minimum z bound on sensor response measurement.
#cal_ceil: 5.                                            #   Maximum z bound on sensor response measurement.
#cal_speed: 1                                         #   Speed while measuring response curve.
#cal_move_speed: 10.                           #   Speed while moving to position for response curve measurement.
#default_model_name: default             #   Name of default beacon model to load.
#mesh_main_direction: x                       #   Primary travel direction during mesh measurement.
#mesh_overscan: -1                               #   Distance to use for direction changes at mesh line ends. Omit this setting and a default will be calculated from line ##spacing and available travel.
#mesh_cluster_size: 1                             #   Radius of mesh grid point clusters.
#mesh_runs:  2                                         #   Number of passes to make during mesh scan.

##########################################################################
## Homing 
##########################################################################

[safe_z_home]
home_xy_position: 155, 155                 #   Sets the x, y position used for z homing with beacon - update for your machine
z_hop: 3                                                 #   Retracts the z axis before x, y homing to avoid dragging the nozzle. 


##########################################################################
## Bed Mesh
##########################################################################

[bed_mesh]
speed: 120                                          #   Movement speed during mesh measurement.
mesh_min = 30, 30
mesh_max = 300, 300
#horizontal_move_z = 2
probe_count = 6,6
#algorithm = bicubic
##[(7x7)-1] / 2 = 24
##[(5x5)-1] / 2 = 12
##[(9x9)-1] / 2 = 40
#relative_reference_index: 40
#zero_reference_position: 150, 150
#relative_reference_index: 15
#split_delta_z = 0.0125
#move_check_distance = 3
#mesh_pps = 4,4
#fade_start = 0
#fade_end = 2
#fade_target = 0

#[bed_screws]
#screw1: 20,20              # Left Front
#screw2: 155,20.           # Middle Front
#screw3: 290,20           # Right Front
#screw4: 20,290.          # Left back
#screw5: 155,290.        # Middle Back
#screw6: 290,290.        # Right Back

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.891
#*# pid_ki = 2.477
#*# pid_kd = 62.538
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 46.371
#*# pid_ki = 1.350
#*# pid_kd = 398.215
#*#
#*# [beacon model default]
#*# model_coef = 1.7149441057869688,
#*# 	  2.030943831623589,
#*# 	  0.6567206351358292,
#*# 	  0.1507475503404171,
#*# 	  0.3470229571277319,
#*# 	  0.5951103351442976,
#*# 	  -0.35298638585091724,
#*# 	  -0.7288939355691909,
#*# 	  0.2364298934543563,
#*# 	  0.356889339653824
#*# model_domain = 3.318984574351052e-07,3.3540068800936687e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 22.959982
#*# model_offset = 0.00000
