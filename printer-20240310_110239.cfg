
##########################################################################
## Included Configs
##########################################################################

[include macros.cfg]
[include neopixel.cfg]
#[include nozzle_scrub.cfg]
#[include timelapse.cfg]
[include spoolman.cfg]
[include speed.cfg]
[include beacon.cfg]
[include VZBot macro.cfg]
[include KAMP_Settings.cfg]
[include config_backup.cfg]

[exclude_object]

##########################################################################
## Mainsail inclusions
##########################################################################

[display_status]

[exclude_object]

[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[pause_resume]

recover_velocity: 350

[firmware_retraction]
#retract_length: 0
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
#retract_speed: 20
#   The speed of retraction, in mm/s. The default is 20 mm/s.
#unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
#unretract_speed: 10
#   The speed of unretraction, in mm/s. The default is 10 mm/s.


##########################################################################
## MCU Section
##########################################################################

[mcu sht36]
canbus_uuid: 21da7204a07b

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_3E0014001050334636383920-if00


##########################################################################
## Printer
##########################################################################

[printer]
kinematics: corexy
max_velocity: 2500                    # VZBot = 2500   Voron = 500
max_accel: 10000                      # VZBOT = 10000  Voron = 3000 
max_accel_to_decel: 5000       # VZBot = 5000   Voron = 8100
max_z_velocity: 20                   # VZBot = 20     Voron = 10
max_z_accel: 1500                     # VZBot = 1500   Voron = 350
square_corner_velocity: 10            # VZBot = 10     Voron = 5

##########################################################################
#  Resonance - Input Shaper - SHT36
##########################################################################

## SHT36 -ADXL345
[adxl345]
cs_pin: sht36:PA9
spi_software_sclk_pin: sht36:PB13
spi_software_mosi_pin: sht36:PB15
spi_software_miso_pin: sht36:PB14

[resonance_tester]
accel_chip: adxl345
probe_points:
    160, 160, 20

[input_shaper]
#shaper_freq_x: 84
#shaper_type_x: mzv
#shaper_freq_y: 47.4
#shaper_type_y: zv


##########################################################################
# SHT36 Temperature sensors
##########################################################################

[temperature_sensor SHT36-V2]     
sensor_type: temperature_mcu      
sensor_mcu: sht36               
min_temp: 0                       
max_temp: 490                     


[temperature_sensor Chamber]          
sensor_type: ATC Semitec 104GT-2  
sensor_pin = sht36:PA4          
min_temp: 0                       
max_temp: 490           

##########################################################################
# Octopus Pros 429 SPI Fix
##########################################################################

#[static_digital_output disable_max31865]
#pins: !PF8


##########################################################################
## Steppers - AWD - TMC 5160 Pro
##########################################################################

[stepper_x]
##	in M0 position
step_pin: PF13
dir_pin: !PF12
enable_pin: !PF14
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  
endstop_pin: ^sht36:PA1            # make sure to set the correct pin here.
position_endstop: -5
position_min: -5                   # 0
position_max: 335
homing_speed: 120 
homing_retract_dist: 5


[tmc2209 stepper_x]                     
uart_pin: PC4
interpolate: false
run_current: 1.2                # 0.8
sense_resistor: 0.110
stealthchop_threshold: 0    #999999

#[tmc5160 stepper_x] 
##spi_bus: spi1
#cs_pin: PC4
##diag_pin: PA8
#interpolate: True
#run_current: 0.8
#sense_resistor: 0.075
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5
#stealthchop_threshold: 0

[stepper_y]
##	in M1 position
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200
endstop_pin: PG6                 #make sure to set the correct pin here.
position_endstop: 325
position_min: 0
position_max: 330
homing_speed: 120 
homing_retract_dist: 5

[tmc2209 stepper_y]               
uart_pin: PD11
interpolate: false
run_current: 1.2                # 0.8
sense_resistor: 0.110
stealthchop_threshold: 0    #999999

#[tmc5160 stepper_y] 
##spi_bus: spi1
#cs_pin: PD11
##diag_pin: PA8
#interpolate: True
#run_current: 0.8
#sense_resistor: 0.075
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5
#stealthchop_threshold: 0

[stepper_x1]
##	in M2_1 position
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200  


[tmc2209 stepper_x1]               
uart_pin: PC6
interpolate: false
run_current: 1.2                # 0.8
sense_resistor: 0.110
stealthchop_threshold: 0       #999999

#[tmc5160 stepper_x1] 
##spi_bus: spi1
#cs_pin: PC6
##diag_pin: PA8
#interpolate: True
#run_current: 0.8
#sense_resistor: 0.075
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5
#stealthchop_threshold: 0

[stepper_y1]
##	in M3 position
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
rotation_distance: 40
microsteps: 16
full_steps_per_rotation: 200

[tmc2209 stepper_y1]              
uart_pin: PC7
interpolate: false
run_current: 1.2                # 0.8
sense_resistor: 0.110
stealthchop_threshold: 0         #999999

#[tmc5160 stepper_y1] 
##spi_bus: spi1
#cs_pin: PC7
##diag_pin: PA8
#interpolate: True
#run_current: 0.8
#sense_resistor: 0.075
#spi_software_mosi_pin: PA7
#spi_software_miso_pin: PA6
#spi_software_sclk_pin: PA5
#stealthchop_threshold: 0

##########################################################################
# Steppers - Other - TMC2209
##########################################################################

[stepper_z]
## In M4 position
step_pin: PF9
dir_pin: !PF10
enable_pin: !PG2
microsteps: 32
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop    # use beacon as virtual endstop
homing_retract_dist: 0                            # Beacon does not require a homing retract. Setting this to something other than 0 will cause occasional erroneous results.
position_max: 400
position_min: -10
full_steps_per_rotation: 200
homing_positive_dir: false
homing_speed: 10.0
second_homing_speed: 5

[tmc2209 stepper_z]
uart_pin: PF2
interpolate: false
run_current: 1.2
sense_resistor: 0.110
stealthchop_threshold: 0              # 999999

[extruder]
## on Canbus SHT36
### Orbiter 2
step_pin: sht36:PB4
dir_pin: !sht36:PB3
enable_pin: !sht36:PA15
microsteps: 16
## Orbiter Extruder
#rotation_distance: 4.7226
#Gear_ratio: 50:8
## Mellow Fly Hextrudort Low
gear_ratio: 60:10
rotation_distance: 35.084
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: sht36:PA8
#sensor_type: ATC Semitec 104GT-2  # this is the default for the Revo heater
sensor_type: ATC Semitec 104NT-4-R025H42G         # Rapido UHF
pullup_resistor: 4700   
sensor_pin: sht36:PA3
#control: pid
#pid_Kp=28.737 
#pid_Ki=1.935 
#pid_Kd=106.684
min_temp: 0
max_temp: 400
full_steps_per_rotation: 200
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 500
max_extrude_only_velocity: 200
max_extrude_only_accel: 10000
min_extrude_temp: 0
pressure_advance: 0.04
pressure_advance_smooth_time: 0.04

[tmc2209 extruder]
uart_pin: sht36:PB5
interpolate: false
run_current: 0.7
sense_resistor: 0.110
stealthchop_threshold: 0        # 999999

##########################################################################â€¨# Heater Bed
##########################################################################

[heater_bed]
heater_pin: PA1
sensor_type: Generic 3950
sensor_pin: PF3
#control: pid
#pid_Kp: 66.746
#pid_Ki: 3.504
#pid_Kd: 317.878
min_temp: 0
max_temp: 130


##########################################################################
#FANS
##########################################################################

[fan]
##	Print Cooling Fan - SHT36 - Fan1
#pin: sht36:PB11
#max_power: 1
#cycle_time: 0.002
#hardware_pwm: false
#shutdown_speed: 0

# Part Cooling fan - CPAP
pin: PG11
max_power: 1
cycle_time: 0.005
hardware_PWM: False
shutdown_speed: 0

[heater_fan hotend_fan]
##	Hotend Fan - SHT36 FAN0 Connector
pin: sht36:PB10
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0

[fan_generic Exhaust_fan]
##  exhaust fan - In FAN0
pin: PA8
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10

#[fan_generic chamber_fan]
###  chamber fan - In FAN9 Position
#pin: PD15
#max_power: 1
#shutdown_speed: 0
#kick_start_time: 0.1
#off_below: 0.10

[fan_generic RSCS]
##  RSCS Fans - In FAN1 Position
pin: PE5
max_power: 1
shutdown_speed: 0
kick_start_time: 0.1
off_below: 0.10

####################################################################
# Add raspberry PI system temperature to the MainSail display
#####################################################################
[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

##########################################################################
#Custom PINs Definition 
##########################################################################

[output_pin Caselight]
# Connected to HE0
pin: PA2
pwm: false
value: 1
shutdown_value:0

[idle_timeout]
timeout: 1800
gcode =
  {% if printer.pause_resume.is_paused %}
    M104 S0
  {% else %}
    TURN_OFF_HEATERS
    #M84
  {% endif %}

########################################################################
## Probe          Beacon Probe Replaces This.                                                                                                            
########################################################################
# See beacon.cfg

##########################################################################
## Homing 
##########################################################################

[safe_z_home]
home_xy_position: 155, 155                 #   Sets the x, y position used for z homing with beacon - update for your machine
z_hop: 3                                   #   Retracts the z axis before x, y homing to avoid dragging the nozzle. 


##########################################################################
## Bed Mesh
##########################################################################

# see beacon.cfg


[bed_screws]
screw1: 20,20              # Left Front
screw2: 155,20.           # Middle Front
screw3: 290,20           # Right Front
screw4: 20,290.          # Left back
screw5: 155,290.        # Middle Back
screw6: 290,290.        # Right Back

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.935
#*# pid_ki = 2.341
#*# pid_kd = 66.391
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 46.511
#*# pid_ki = 1.276
#*# pid_kd = 423.828
#*#
#*# [beacon model default]
#*# model_coef = 1.5039624018146225,
#*# 	1.8285796515950052,
#*# 	0.748503687480754,
#*# 	0.3891099679238303,
#*# 	0.38139953314187985,
#*# 	0.1635297403112749,
#*# 	-0.26326827896519955,
#*# 	-0.07325832008964224,
#*# 	0.230466347536681,
#*# 	0.09465564790970765
#*# model_domain = 3.207664008288111e-07,3.3321271070661e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 60.940651
#*# model_offset = 0.00000
#*#
#*# [bed_mesh Hotbed]
#*# version = 1
#*# points =
#*# 	-0.434302, -0.327842, -0.248038, -0.179238, -0.095800, -0.022214, 0.046295, 0.112916, 0.178243, 0.230501, 0.275829, 0.317095, 0.357257, 0.388056, 0.428097
#*# 	-0.449379, -0.360936, -0.278492, -0.199044, -0.126356, -0.052918, 0.018030, 0.085562, 0.146686, 0.199189, 0.247500, 0.290781, 0.332318, 0.366109, 0.402060
#*# 	-0.466224, -0.372454, -0.292130, -0.216591, -0.152964, -0.067665, 0.000187, 0.067808, 0.128909, 0.185076, 0.233884, 0.274170, 0.318212, 0.363544, 0.400351
#*# 	-0.477161, -0.385031, -0.299054, -0.224632, -0.148176, -0.072213, -0.004516, 0.060239, 0.126092, 0.185954, 0.234053, 0.275143, 0.316335, 0.364919, 0.401697
#*# 	-0.488821, -0.397213, -0.313631, -0.236563, -0.161222, -0.085912, -0.016989, 0.045462, 0.115708, 0.182335, 0.236836, 0.289181, 0.333028, 0.378561, 0.407334
#*# 	-0.514478, -0.424383, -0.338937, -0.259818, -0.180990, -0.102830, -0.031911, 0.032445, 0.104268, 0.176408, 0.235918, 0.286739, 0.343387, 0.394616, 0.429568
#*# 	-0.547493, -0.457950, -0.371285, -0.289421, -0.210736, -0.129259, -0.054401, 0.018834, 0.086434, 0.163879, 0.224639, 0.283674, 0.345907, 0.394959, 0.431396
#*# 	-0.576787, -0.482376, -0.396140, -0.314839, -0.234790, -0.150013, -0.070434, 0.002368, 0.075884, 0.149781, 0.214011, 0.273132, 0.335972, 0.390205, 0.432682
#*# 	-0.605813, -0.508798, -0.422594, -0.339862, -0.261944, -0.172847, -0.093903, -0.013857, 0.060721, 0.131255, 0.199993, 0.260791, 0.322915, 0.377958, 0.424504
#*# 	-0.640946, -0.542487, -0.449844, -0.368526, -0.285509, -0.196597, -0.113023, -0.032622, 0.043428, 0.118123, 0.187385, 0.248486, 0.309328, 0.359620, 0.411245
#*# 	-0.674553, -0.574714, -0.479303, -0.392452, -0.306612, -0.220247, -0.134673, -0.053278, 0.025169, 0.103325, 0.172137, 0.235350, 0.294668, 0.349997, 0.401628
#*# 	-0.699540, -0.602080, -0.507348, -0.415034, -0.324210, -0.236955, -0.152795, -0.069657, 0.009693, 0.086544, 0.160858, 0.226472, 0.289067, 0.352309, 0.405239
#*# 	-0.711256, -0.612393, -0.517432, -0.424503, -0.333250, -0.242280, -0.155974, -0.073326, 0.009907, 0.089125, 0.160508, 0.226636, 0.292722, 0.361993, 0.416590
#*# 	-0.720585, -0.618478, -0.520888, -0.424564, -0.330415, -0.237304, -0.145248, -0.061844, 0.022931, 0.101860, 0.175865, 0.242772, 0.310639, 0.381402, 0.443287
#*# 	-0.723940, -0.623861, -0.522347, -0.423354, -0.328572, -0.231863, -0.138942, -0.053484, 0.037728, 0.117127, 0.193147, 0.262310, 0.332870, 0.404672, 0.470489
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 280.0
#*# min_y = 40.0
#*# max_y = 280.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.132397, 0.148308, 0.130242, 0.103513, 0.108704, 0.084992, 0.058077, 0.049456, 0.030561, 0.008765, -0.021769, -0.044591, -0.086131, -0.118923, -0.132332
#*# 	0.137799, 0.134784, 0.122385, 0.112244, 0.105641, 0.080200, 0.065590, 0.048722, 0.022151, 0.014340, -0.006742, -0.048908, -0.069860, -0.090611, -0.129282
#*# 	0.127524, 0.126742, 0.119181, 0.102713, 0.096061, 0.075209, 0.048019, 0.043844, 0.025757, 0.006075, -0.003194, -0.036679, -0.059538, -0.064008, -0.110428
#*# 	0.099761, 0.104539, 0.093355, 0.078486, 0.071465, 0.056680, 0.038262, 0.028785, 0.024903, 0.006717, -0.006335, -0.024514, -0.045019, -0.058440, -0.090712
#*# 	0.079408, 0.074077, 0.063017, 0.061026, 0.047314, 0.034558, 0.036325, 0.018217, 0.002976, 0.012454, -0.006506, -0.033264, -0.031254, -0.049731, -0.083064
#*# 	0.054147, 0.057122, 0.055534, 0.038924, 0.032050, 0.031898, 0.018247, 0.012264, 0.008221, -0.000110, -0.012449, -0.029973, -0.040258, -0.053560, -0.077109
#*# 	0.035048, 0.034528, 0.037254, 0.022347, 0.009464, 0.020320, 0.010081, -0.002022, -0.001213, -0.009252, -0.024671, -0.037670, -0.042951, -0.061492, -0.085313
#*# 	0.011753, 0.014279, 0.014330, 0.007329, -0.002699, 0.001152, -0.001150, -0.006817, -0.010445, -0.014888, -0.026404, -0.042246, -0.052481, -0.073395, -0.095438
#*# 	-0.011297, -0.008865, -0.005978, -0.007588, -0.012606, -0.012417, -0.014602, -0.015953, -0.017975, -0.023484, -0.034181, -0.048679, -0.059863, -0.075816, -0.093500
#*# 	-0.024038, -0.021632, -0.019233, -0.016388, -0.016101, -0.014777, -0.017669, -0.019586, -0.019498, -0.024850, -0.033449, -0.046977, -0.056104, -0.063733, -0.078774
#*# 	-0.024598, -0.021724, -0.016479, -0.013893, -0.010866, -0.007080, -0.008066, -0.010288, -0.009248, -0.011403, -0.019984, -0.033938, -0.041624, -0.045504, -0.057416
#*# 	-0.024529, -0.015189, -0.006469, -0.001656, 0.001967, 0.009704, 0.013916, 0.012067, 0.015044, 0.013912, 0.005240, -0.007167, -0.013631, -0.015393, -0.017913
#*# 	-0.018579, -0.005374, 0.007168, 0.013473, 0.020564, 0.029067, 0.037560, 0.039814, 0.044820, 0.041549, 0.033581, 0.021635, 0.018151, 0.015957, 0.015878
#*# x_count = 15
#*# y_count = 13
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 31.0901
#*# max_x = 280.0
#*# min_y = 83.5554
#*# max_y = 280.0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 104.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 64.0
